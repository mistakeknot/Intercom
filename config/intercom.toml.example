# Intercom Rust daemon config
# Copy to config/intercom.toml and adjust for your environment.
# Telegram bridge endpoints use TELEGRAM_BOT_TOKEN from environment.

[server]
bind = "127.0.0.1:7340"
request_timeout_ms = 30000
max_body_bytes = 1048576
# URL of Node host's callback server for IPC message/task forwarding
host_callback_url = "http://127.0.0.1:7341"

[storage]
# Optional for later phases. If omitted, Postgres is disabled.
postgres_dsn = "postgres://intercom:intercom@localhost:5432/intercom"
sqlite_legacy_path = "store/messages.db"
groups_dir = "groups"

[runtimes]
preserve_legacy_runtime_ids = true
default_runtime = "claude"

[runtimes.profiles.claude]
provider = "anthropic"
default_model = "claude-opus-4-6"
required_env = ["CLAUDE_CODE_OAUTH_TOKEN"]

[runtimes.profiles.gemini]
provider = "code-assist"
default_model = "gemini-3.1-pro"
required_env = [
  "GEMINI_REFRESH_TOKEN",
  "GEMINI_OAUTH_CLIENT_ID",
  "GEMINI_OAUTH_CLIENT_SECRET",
]

[runtimes.profiles.codex]
provider = "openai"
default_model = "gpt-5.3-codex"
required_env = [
  "CODEX_OAUTH_ACCESS_TOKEN",
  "CODEX_OAUTH_REFRESH_TOKEN",
  "CODEX_OAUTH_ID_TOKEN",
  "CODEX_OAUTH_ACCOUNT_ID",
]

[events]
# Enable push notifications from kernel events (gate approvals, run completions, etc.)
enabled = false
poll_interval_ms = 1000
batch_size = 20
# notification_jid = "tg:1108701034"  # Chat JID for push notifications

[orchestrator]
# Enable the Rust orchestrator (message loop, queue, container dispatch).
# When false, intercomd runs as a sidecar only â€” Node remains the orchestrator.
enabled = false
# Maximum concurrent containers across all groups.
max_concurrent_containers = 3
# Poll interval for the message loop (milliseconds).
poll_interval_ms = 1000
# Idle timeout before closing container stdin (milliseconds). Default: 5 minutes.
idle_timeout_ms = 300000
# Folder name for the main group (receives all unmatched messages).
main_group_folder = "main"

[scheduler]
# Enable the task scheduler loop (cron/interval/once scheduled tasks).
enabled = false
# Poll interval for due tasks (milliseconds).
poll_interval_ms = 10000
# IANA timezone for cron expressions (e.g., "Europe/Berlin").
timezone = "UTC"

[demarch]
enabled = true
require_main_group_for_writes = true
read_allowlist = [
  "ic run current --json",
  "ic run status --json",
  "ic run phase --json",
  "ic run artifact list --json",
  "ic run artifact get --json",
  "ic events tail --consumer=intercom --json",
  "bd list --json",
  "bd ready --json",
  "bd show --json",
]
write_allowlist = [
  "bd create --json",
  "bd update --json",
  "bd close --json",
  "ic gate override --json",
  "ic run create --json",
]
